name: run-unit-tests

on: push

jobs:
  test:
    runs-on: ubuntu-22.04
    container: python:3.11-slim
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: 'Create env file'
        run: |
          touch .env
          echo OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} >> .env
      
      - name: Install dependencies
        run: |
          apt-get update && apt-get install -y curl build-essential

      - name: Install Poetry
        run: pip install poetry

      - name: Install Python
        uses: actions/setup-python@v3
        with:
          python-version: 3.11
          cache: poetry

      - name: Install Python libraries
        run: poetry install
      
      - name: Run tests with coverage
        run: poetry run pytest --cache-clear -vv tests --cov='lamoom_cicd' --cov-fail-under=80 --cov-report term-missing
